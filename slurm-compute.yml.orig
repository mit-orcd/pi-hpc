# /etc/ansible/slurm-compute.yml
---
- name: Install and configure Slurm compute nodes
  hosts: compute
  become: true
  gather_facts: true

  vars:
    slurm_user: "slurm"
    slurm_log_dir: "/var/log/slurm"
    munge_key_dest: "/etc/munge/munge.key"
    # Path where we fetched the key from controller (previous play)
    munge_key_src: "/etc/ansible/artifacts/headnode/munge.key"

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

  tasks:
    - name: Install compute packages
      apt:
        name:
          - slurmd
          - slurm-client
          - munge
          - libmunge2
        state: present

    - name: Ensure log directory exists
      file:
        path: "{{ slurm_log_dir }}"
        state: directory
        owner: "{{ slurm_user }}"
        group: "{{ slurm_user }}"
        mode: "0755"

    - name: Distribute munge key
      copy:
        src: "{{ munge_key_src }}"
        dest: "{{ munge_key_dest }}"
        owner: munge
        group: munge
        mode: "0400"
      notify: Restart munge

    - name: Deploy slurm.conf
      template:
        src: templates/slurm.conf
        dest: /etc/slurm/slurm.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart slurmd

    - name: Enable and start munge
      service:
        name: munge
        state: started
        enabled: true

    - name: Enable and start slurmd
      service:
        name: slurmd
        state: started
        enabled: true

  handlers:
    - name: Restart munge
      service:
        name: munge
        state: restarted

    - name: Restart slurmd
      service:
        name: slurmd
        state: restarted
